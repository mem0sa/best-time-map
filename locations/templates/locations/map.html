<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Лучшее время посещения</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
    <script
    src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initMap"
    async
    defer
    ></script>
<body>
<div id="details" style="
    position: absolute;
    right: 10px;
    top: 10px;
    background: white;
    padding: 15px;
    max-width: 300px;
    z-index: 1000;
    display: none;
"></div>
<div id="map"></div>
    <script>
    let map;
    let activePlaceId = null;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 55.751244, lng: 37.618423 },
            zoom: 14,
        });

        map.addListener("click", (event) => {
            if (event.placeId) {
                event.stop();
                handlePlaceClick(event.placeId);
            }
        });
    }

    function handlePlaceClick(placeId) {
        if (activePlaceId === placeId) {
            return;
        }

        closeDetailsPanel();
        activePlaceId = placeId;

        fetch('/api/place-details/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ place_id: placeId })
        })
        .then(res => res.json())
        .then(data => {
            showPlaceDetails(data.details);
        })
        .catch(() => {
            activePlaceId = null;
        });
    }

    function fetchPlaceDetails(placeId) {
        fetch('/api/place-details/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ place_id: placeId })
        })
        .then(res => res.json())
        .then(data => {
            showPlaceDetails(data.details);
        });
    }

    function showPlaceDetails(details) {
        const panel = document.getElementById("details");

        panel.innerHTML = `
            <button onclick="closeDetailsPanel()" style="float:right;">×</button>
            <h3>${details.name}</h3>
            <p>${details.address}</p>
            <p><strong>Рейтинг:</strong> ${details.rating ?? '—'}</p>
        `;

        panel.style.display = "block";
    }

    function closeDetailsPanel() {
    const panel = document.getElementById("details");

    panel.style.display = "none";
    panel.innerHTML = "";
    }
    </script>
</body>
</html>
